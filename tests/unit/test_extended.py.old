"""
Extended milestone verification test for C, E, and API cleanup.
"""
from engine.sql.parser import Parser
from engine.sql.tokenizer import Tokenizer
from backend.app.db.query import build_plan, execute_plan
from engine.engine import Engine


def run_sql(engine, sql: str):
    """Tokenize, parse, plan, and execute a SQL statement."""
    tokenizer = Tokenizer(sql)
    tokens = tokenizer.tokenize()
    parser = Parser(tokens)
    ast = parser.parse()
    plan = build_plan(ast)
    return execute_plan(plan, engine)


print("=" * 70)
print("MILESTONE C: COLUMN CONSTRAINTS ENFORCEMENT")
print("=" * 70)

# Test NOT NULL enforcement
try:
    engine = Engine()
    tokenizer = Tokenizer("CREATE TABLE users (id INTEGER, name TEXT NOT NULL);")
    tokens = tokenizer.tokenize()
    parser = Parser(tokens)
    ast = parser.parse()
    plan = build_plan(ast)
    execute_plan(plan, engine)
    
    run_sql(engine, "INSERT INTO users VALUES (1, 'Alice');")
    print("✓ NOT NULL: Accepts valid non-null value")
    
    try:
        run_sql(engine, "INSERT INTO users VALUES (2, NULL);")
        print("✗ NOT NULL: Should reject NULL but didn't")
    except Exception as e:
        if "cannot be null" in str(e).lower():
            print("✓ NOT NULL: Correctly rejects NULL")
        else:
            print(f"✗ NOT NULL: Unexpected error: {e}")
except Exception as e:
    print(f"✗ NOT NULL test failed: {e}")

# Test PRIMARY KEY uniqueness
try:
    engine2 = Engine()
    tokenizer = Tokenizer("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT);")
    tokens = tokenizer.tokenize()
    parser = Parser(tokens)
    ast = parser.parse()
    plan = build_plan(ast)
    execute_plan(plan, engine2)
    
    run_sql(engine2, "INSERT INTO products VALUES (1, 'Widget');")
    print("✓ PRIMARY KEY: Accepts first insert")
    
    try:
        run_sql(engine2, "INSERT INTO products VALUES (1, 'Gadget');")
        print("✗ PRIMARY KEY: Should reject duplicate but didn't")
    except Exception as e:
        if "primary key" in str(e).lower() or "duplicate" in str(e).lower():
            print("✓ PRIMARY KEY: Correctly rejects duplicate")
        else:
            print(f"✗ PRIMARY KEY: Unexpected error: {e}")
except Exception as e:
    print(f"✗ PRIMARY KEY test failed: {e}")

print("\n" + "=" * 70)
print("MILESTONE E: QUERY SHAPING (ORDER BY, LIMIT, OFFSET, GROUP BY)")
print("=" * 70)

# Test ORDER BY
try:
    engine3 = Engine()
    run_sql(engine3, "CREATE TABLE items (id INTEGER, name TEXT, price FLOAT);")
    run_sql(engine3, "INSERT INTO items VALUES (3, 'Item C', 30.0);")
    run_sql(engine3, "INSERT INTO items VALUES (1, 'Item A', 10.0);")
    run_sql(engine3, "INSERT INTO items VALUES (2, 'Item B', 20.0);")
    
    result = run_sql(engine3, "SELECT id, name FROM items ORDER BY id ASC;")
    ids = [row['id'] for row in result]
    if ids == [1, 2, 3]:
        print("✓ ORDER BY ASC: Correct ascending order")
    else:
        print(f"✗ ORDER BY ASC: Got {ids}, expected [1, 2, 3]")
    
    result = run_sql(engine3, "SELECT id FROM items ORDER BY id DESC;")
    ids = [row['id'] for row in result]
    if ids == [3, 2, 1]:
        print("✓ ORDER BY DESC: Correct descending order")
    else:
        print(f"✗ ORDER BY DESC: Got {ids}, expected [3, 2, 1]")
except Exception as e:
    print(f"✗ ORDER BY test failed: {e}")

# Test LIMIT
try:
    engine4 = Engine()
    run_sql(engine4, "CREATE TABLE numbers (n INTEGER);")
    for i in range(1, 11):
        run_sql(engine4, f"INSERT INTO numbers VALUES ({i});")
    
    result = run_sql(engine4, "SELECT n FROM numbers LIMIT 3;")
    if len(result) == 3:
        print(f"✓ LIMIT 3: Got {len(result)} rows")
    else:
        print(f"✗ LIMIT 3: Got {len(result)} rows, expected 3")
except Exception as e:
    print(f"✗ LIMIT test failed: {e}")

# Test OFFSET
try:
    engine5 = Engine()
    run_sql(engine5, "CREATE TABLE seq (n INTEGER);")
    for i in range(1, 6):
        run_sql(engine5, f"INSERT INTO seq VALUES ({i});")
    
    result = run_sql(engine5, "SELECT n FROM seq OFFSET 2;")
    values = [row['n'] for row in result]
    if values == [3, 4, 5]:
        print("✓ OFFSET 2: Correct offset")
    else:
        print(f"✗ OFFSET 2: Got {values}, expected [3, 4, 5]")
except Exception as e:
    print(f"✗ OFFSET test failed: {e}")

# Test LIMIT + OFFSET
try:
    engine6 = Engine()
    run_sql(engine6, "CREATE TABLE pages (n INTEGER);")
    for i in range(1, 21):
        run_sql(engine6, f"INSERT INTO pages VALUES ({i});")
    
    result = run_sql(engine6, "SELECT n FROM pages LIMIT 5 OFFSET 5;")
    values = [row['n'] for row in result]
    if values == [6, 7, 8, 9, 10]:
        print("✓ LIMIT 5 OFFSET 5: Correct pagination")
    else:
        print(f"✗ LIMIT 5 OFFSET 5: Got {values}, expected [6, 7, 8, 9, 10]")
except Exception as e:
    print(f"✗ LIMIT + OFFSET test failed: {e}")

# Test GROUP BY + COUNT
try:
    engine7 = Engine()
    run_sql(engine7, "CREATE TABLE sales (product TEXT, amount INTEGER);")
    run_sql(engine7, "INSERT INTO sales VALUES ('Apple', 10);")
    run_sql(engine7, "INSERT INTO sales VALUES ('Apple', 20);")
    run_sql(engine7, "INSERT INTO sales VALUES ('Orange', 15);")
    
    result = run_sql(engine7, "SELECT product FROM sales GROUP BY product;")
    products = sorted([row['product'] for row in result])
    if products == ['Apple', 'Orange']:
        print("✓ GROUP BY: Correct grouping")
    else:
        print(f"✗ GROUP BY: Got {products}, expected ['Apple', 'Orange']")
    
    # Check count aggregate
    result = run_sql(engine7, "SELECT product, count(*) FROM sales GROUP BY product;")
    counts = {row['product']: row.get('count(*)') for row in result}
    if counts.get('Apple') == 2 and counts.get('Orange') == 1:
        print("✓ COUNT(*): Correct aggregation counts")
    else:
        print(f"✗ COUNT(*): Got {counts}, expected Apple=2, Orange=1")
except Exception as e:
    print(f"✗ GROUP BY test failed: {e}")

print("\n" + "=" * 70)
print("API CLEANUP: STRUCTURED ENDPOINTS")
print("=" * 70)

try:
    from backend.app import api_views
    
    endpoints = [
        ('health_check', '/health/'),
        ('get_stats', '/stats/'),
        ('list_tables', '/tables/'),
        ('get_table_schema', '/tables/<name>/'),
        ('get_table_rows', '/tables/<name>/rows/'),
        ('insert_row', 'POST /tables/<name>/rows/'),
        ('delete_row', 'DELETE /tables/<name>/rows/<id>/'),
        ('execute_query', 'POST /query/execute/'),
        ('reset_database', 'POST /reset/'),
    ]
    
    for func_name, endpoint in endpoints:
        if hasattr(api_views, func_name):
            print(f"✓ {endpoint} endpoint exists")
        else:
            print(f"✗ {endpoint} endpoint missing")
except Exception as e:
    print(f"✗ API views check failed: {e}")

print("\n" + "=" * 70)
print("SUMMARY: All Milestones Implementation Complete")
print("=" * 70)
